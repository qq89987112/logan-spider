<html>
    <head>
        <meta charset='UTF-8'></meta>
        <link rel='stylesheet', href='./reset.css'>
        <link rel='stylesheet', href='../node_modules/element-ui/lib/theme-chalk/index.css'>
        <style>
            #app {
                padding: 10px;
            }
            .line2 {
                overflow: hidden;
                text-overflow: ellipsis;
                word-break: break-all;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <el-tabs v-for="item in tabs">
                <el-tab-pane :label="item.name">
                    <el-form :inline="true" size="small" @submit.native="item.reLoad">
                        <el-form-item :label="key" v-for="key in item.keys">
                            <el-input v-model="item.tableSearch[key]"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button @click="item.reLoad">查询</el-button>
                        </el-form-item>
                    </el-form>
                    <el-table size="mini" border :data="item.children">
                        <el-table-column :prop="key" :label="key" v-for="key in item.keys">
                            <template slot-scope="props">
                                <el-popover placement="bottom" trigger="hover">
                                  <pre style="max-height: 95vh; overflow-y: auto">{{props.row[key]}}</pre>
                                  <div class="line2" slot="reference">{{props.row[key]}}</div>
                                </el-popover>
                            </template>
                        </el-table-column>
                    </el-table>
                    <el-pagination v-if="item.filterd.length > item.pageSize" style="text-align: center" @size-change="item.onSizeChange" @current-change="item.onCurrentChange" :current-page.sync="item.viewPage" :page-sizes="[10, 20, 30, 40]" :page-size="item.pageSize" layout="total, sizes, prev, pager, next, jumper" :total="item.filterd.length"></el-pagination>
                </el-tab-pane>
            </el-tabs>
        </div>
        <script src='../node_modules/vue/dist/vue.min.js'></script>
        <script src='../node_modules/element-ui/lib/index.js'></script>
        <script>
            new Vue({
                el: "#app",
                data() {
                    return {
                        list: {}
                    }
                },
                computed: {
                    tabs () {
                        const self = this
                        return Object.entries(this.list).map(i => {
                            
                            const ret = {
                                name: i[0],
                                children: i[1].slice(0, 10),
                                filterd: i[1],
                                total: i[1],
                                viewPage: 1,
                                pageSize: 10,
                                keys: i[1][0] ? Object.keys(i[1][0]).filter(i => i !== '$type') : [],
                                tableSearch: {},
                                reLoad () {
                                    const filter = Object.entries(ret.tableSearch)
                                    if (filter.length) {
                                        ret.filterd = ret.total.filter(i => filter.some(cur =>{
                                            let [key ,value] = cur
                                            return i[key].indexOf(value) > -1
                                        }))
                                    } else {
                                        ret.filterd = [...ret.total]
                                    }
                                    ret.viewPage = 1
                                    ret.updateData()
                                },
                                updateData () {
                                    const temp = ret.viewPage * ret.pageSize
                                    ret.children = ret.filterd.slice(temp - ret.pageSize, temp)
                                    self.$forceUpdate()
                                },
                                onSizeChange(pageSize) {
                                    ret.pageSize = pageSize;
                                    ret.viewPage = 1;
                                    ret.updateData()
                                },
                                onCurrentChange (viewPage) {
                                    ret.viewPage = viewPage;
                                    ret.updateData()
                                },
                            }
                            return ret
                        })
                    }
                },
                mounted() {
                    const self = this
                    const ws = new WebSocket('ws://127.0.0.1:3000');
                    ws.onopen = function(e) {
                        console.log("连接成功!");
                    };
                    ws.onerror = function(e) {
                        console.error("连接失败!", e);
                    }
                    ws.onclose = function(e) {};
                    ws.onmessage = function(e) {
                        let message = JSON.parse(e.data);
                        console.log(`收到消息： `,message)
                        if (message.type == 'list') {
                            self.list = message.data
                            self.$nextTick(()=>{
                                console.log(self.tabs)
                            })
                        }
                    }
                },
                methods: {
                }
            })
        </script>
    </body>
</html>